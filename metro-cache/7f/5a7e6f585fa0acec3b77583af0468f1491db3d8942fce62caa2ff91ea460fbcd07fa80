{"dependencies":[{"name":"@babel/runtime/helpers/interopRequireDefault","data":{"isAsync":false}},{"name":"@babel/runtime/regenerator","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/classCallCheck","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/createClass","data":{"isAsync":false}},{"name":"../../utils/events","data":{"isAsync":false}},{"name":"../../utils/native","data":{"isAsync":false}},{"name":"./Transaction","data":{"isAsync":false}}],"output":[{"data":{"code":"__d(function (global, _$$_REQUIRE, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  var _interopRequireDefault = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\");\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = void 0;\n\n  var _regenerator = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[1], \"@babel/runtime/regenerator\"));\n\n  var _classCallCheck2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[2], \"@babel/runtime/helpers/classCallCheck\"));\n\n  var _createClass2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[3], \"@babel/runtime/helpers/createClass\"));\n\n  var _events = _$$_REQUIRE(_dependencyMap[4], \"../../utils/events\");\n\n  var _native = _$$_REQUIRE(_dependencyMap[5], \"../../utils/native\");\n\n  var _Transaction = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[6], \"./Transaction\"));\n\n  var transactionId = 0;\n\n  var generateTransactionId = function generateTransactionId() {\n    return transactionId++;\n  };\n\n  var TransactionHandler = function () {\n    function TransactionHandler(firestore) {\n      (0, _classCallCheck2.default)(this, TransactionHandler);\n      this._pending = {};\n      this._firestore = firestore;\n\n      _events.SharedEventEmitter.addListener((0, _events.getAppEventName)(this._firestore, 'firestore_transaction_event'), this._handleTransactionEvent.bind(this));\n    }\n\n    (0, _createClass2.default)(TransactionHandler, [{\n      key: \"_add\",\n      value: function _add(updateFunction) {\n        var _this = this;\n\n        var id = generateTransactionId();\n        var meta = {\n          id: id,\n          updateFunction: updateFunction,\n          stack: new Error().stack.split('\\n').slice(2).join('\\n')\n        };\n        this._pending[id] = {\n          meta: meta,\n          transaction: new _Transaction.default(this._firestore, meta)\n        };\n        return new Promise(function (resolve, reject) {\n          (0, _native.getNativeModule)(_this._firestore).transactionBegin(id);\n\n          meta.resolve = function (r) {\n            resolve(r);\n\n            _this._remove(id);\n          };\n\n          meta.reject = function (e) {\n            reject(e);\n\n            _this._remove(id);\n          };\n        });\n      }\n    }, {\n      key: \"_remove\",\n      value: function _remove(id) {\n        (0, _native.getNativeModule)(this._firestore).transactionDispose(id);\n        delete this._pending[id];\n      }\n    }, {\n      key: \"_handleTransactionEvent\",\n      value: function _handleTransactionEvent(event) {\n        switch (event.type) {\n          case 'update':\n            this._handleUpdate(event);\n\n            break;\n\n          case 'error':\n            this._handleError(event);\n\n            break;\n\n          case 'complete':\n            this._handleComplete(event);\n\n            break;\n        }\n      }\n    }, {\n      key: \"_handleUpdate\",\n      value: function _handleUpdate(event) {\n        var id, _this$_pending$id, meta, transaction, updateFunction, reject, finalError, updateFailed, pendingResult, possiblePromise;\n\n        return _regenerator.default.async(function _handleUpdate$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                id = event.id;\n\n                if (this._pending[id]) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", this._remove(id));\n\n              case 3:\n                _this$_pending$id = this._pending[id], meta = _this$_pending$id.meta, transaction = _this$_pending$id.transaction;\n                updateFunction = meta.updateFunction, reject = meta.reject;\n\n                transaction._prepare();\n\n                _context.prev = 6;\n                possiblePromise = updateFunction(transaction);\n\n                if (!(!possiblePromise || !possiblePromise.then)) {\n                  _context.next = 12;\n                  break;\n                }\n\n                finalError = new Error('Update function for `firestore.runTransaction(updateFunction)` must return a Promise.');\n                _context.next = 15;\n                break;\n\n              case 12:\n                _context.next = 14;\n                return _regenerator.default.awrap(possiblePromise);\n\n              case 14:\n                pendingResult = _context.sent;\n\n              case 15:\n                _context.next = 21;\n                break;\n\n              case 17:\n                _context.prev = 17;\n                _context.t0 = _context[\"catch\"](6);\n                updateFailed = true;\n                finalError = _context.t0;\n\n              case 21:\n                if (!(updateFailed || finalError)) {\n                  _context.next = 23;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", reject(finalError));\n\n              case 23:\n                transaction._pendingResult = pendingResult;\n                return _context.abrupt(\"return\", (0, _native.getNativeModule)(this._firestore).transactionApplyBuffer(id, transaction._commandBuffer));\n\n              case 25:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, null, this, [[6, 17]]);\n      }\n    }, {\n      key: \"_handleError\",\n      value: function _handleError(event) {\n        var id = event.id,\n            error = event.error;\n        var meta = this._pending[id].meta;\n\n        if (meta && error) {\n          var code = error.code,\n              message = error.message;\n          var errorWithStack = new Error(message);\n          errorWithStack.code = code;\n          errorWithStack.stack = \"Error: \" + message + \"\\n\" + meta.stack;\n          meta.reject(errorWithStack);\n        }\n      }\n    }, {\n      key: \"_handleComplete\",\n      value: function _handleComplete(event) {\n        var id = event.id;\n        var _this$_pending$id2 = this._pending[id],\n            meta = _this$_pending$id2.meta,\n            transaction = _this$_pending$id2.transaction;\n\n        if (meta) {\n          var pendingResult = transaction._pendingResult;\n          meta.resolve(pendingResult);\n        }\n      }\n    }]);\n    return TransactionHandler;\n  }();\n\n  exports.default = TransactionHandler;\n});","map":[[15,0,5,0],[17,0,6,0],[19,0,7,0],[21,0,8,0],[21,6,8,4,"transactionId"],[21,19,8,17],[21,22,8,20],[21,23,8,0],[23,0,15,0],[23,6,15,6,"generateTransactionId"],[23,27,15,27],[23,30,15,30],[23,39,15,6,"generateTransactionId"],[23,60,15,30],[24,0,15,30],[24,11,15,36,"transactionId"],[24,24,15,49],[24,26,15,30],[25,0,15,30],[25,3,15,0],[27,6,20,21,"TransactionHandler"],[27,24],[28,0,21,2],[28,32,21,14,"firestore"],[28,41,21,2],[28,43,21,25],[29,0,21,25],[30,0,22,4],[30,11,22,9,"_pending"],[30,19,22,4],[30,22,22,20],[30,24,22,4],[31,0,23,4],[31,11,23,9,"_firestore"],[31,21,23,4],[31,24,23,22,"firestore"],[31,33,23,4],[33,0,24,4,"SharedEventEmitter"],[33,33,24,23,"addListener"],[33,44,24,4],[33,45,24,35],[33,74,24,51],[33,79,24,56,"_firestore"],[33,89,24,35],[33,91,24,68],[33,120,24,35],[33,121,24,4],[33,123,24,100],[33,128,24,105,"_handleTransactionEvent"],[33,151,24,100],[33,152,24,129,"bind"],[33,156,24,100],[33,157,24,134],[33,161,24,100],[33,162,24,4],[34,0,25,3],[38,27,38,7,"updateFunction"],[38,41],[38,43,38,23],[39,0,38,23],[41,0,39,4],[41,12,39,10,"id"],[41,14,39,12],[41,17,39,15,"generateTransactionId"],[41,38,39,36],[41,40,39,4],[42,0,41,4],[42,12,41,10,"meta"],[42,16,41,14],[42,19,41,17],[43,0,42,6,"id"],[43,10,42,6,"id"],[43,12,42,8],[43,14,42,6,"id"],[43,16,41,17],[44,0,43,6,"updateFunction"],[44,10,43,6,"updateFunction"],[44,24,43,20],[44,26,43,6,"updateFunction"],[44,40,41,17],[45,0,44,6,"stack"],[45,10,44,6,"stack"],[45,15,44,11],[45,17,44,13],[45,21,44,17,"Error"],[45,26,44,13],[45,29,44,25,"stack"],[45,34,44,13],[45,35,44,31,"split"],[45,40,44,13],[45,41,44,37],[45,45,44,13],[45,47,44,43,"slice"],[45,52,44,13],[45,53,44,49],[45,54,44,13],[45,56,44,52,"join"],[45,60,44,13],[45,61,44,57],[45,65,44,13],[46,0,41,17],[46,9,41,4],[47,0,46,4],[47,13,46,9,"_pending"],[47,21,46,4],[47,22,46,18,"id"],[47,24,46,4],[47,28,46,24],[48,0,47,6,"meta"],[48,10,47,6,"meta"],[48,14,47,10],[48,16,47,6,"meta"],[48,20,46,24],[49,0,48,6,"transaction"],[49,10,48,6,"transaction"],[49,21,48,17],[49,23,48,19],[49,27,48,23,"Transaction"],[49,47,48,19],[49,48,48,35],[49,53,48,40,"_firestore"],[49,63,48,19],[49,65,48,52,"meta"],[49,69,48,19],[50,0,46,24],[50,9,46,4],[51,0,51,4],[51,15,51,11],[51,19,51,15,"Promise"],[51,26,51,11],[51,27,51,23],[51,37,51,24,"resolve"],[51,44,51,23],[51,46,51,33,"reject"],[51,52,51,23],[51,54,51,44],[52,0,52,6],[52,39,52,22],[52,44,52,26],[52,45,52,27,"_firestore"],[52,55,52,6],[52,57,52,39,"transactionBegin"],[52,73,52,6],[52,74,52,56,"id"],[52,76,52,6],[54,0,54,6,"meta"],[54,10,54,6,"meta"],[54,14,54,10],[54,15,54,11,"resolve"],[54,22,54,6],[54,25,54,21],[54,35,54,21,"r"],[54,36,54,22],[54,38,54,26],[55,0,55,8,"resolve"],[55,12,55,8,"resolve"],[55,19,55,15],[55,20,55,16,"r"],[55,21,55,15],[55,22,55,8],[57,0,57,8],[57,12,57,8],[57,17,57,12],[57,18,57,13,"_remove"],[57,25,57,8],[57,26,57,21,"id"],[57,28,57,8],[58,0,58,7],[58,11,54,6],[60,0,60,6,"meta"],[60,10,60,6,"meta"],[60,14,60,10],[60,15,60,11,"reject"],[60,21,60,6],[60,24,60,20],[60,34,60,20,"e"],[60,35,60,21],[60,37,60,25],[61,0,61,8,"reject"],[61,12,61,8,"reject"],[61,18,61,14],[61,19,61,15,"e"],[61,20,61,14],[61,21,61,8],[63,0,63,8],[63,12,63,8],[63,17,63,12],[63,18,63,13,"_remove"],[63,25,63,8],[63,26,63,21,"id"],[63,28,63,8],[64,0,64,7],[64,11,60,6],[65,0,65,5],[65,9,51,11],[65,10,51,4],[66,0,66,3],[69,30,75,10,"id"],[69,32],[69,34,75,14],[70,0,76,4],[70,37,76,20],[70,42,76,25,"_firestore"],[70,52,76,4],[70,54,76,37,"transactionDispose"],[70,72,76,4],[70,73,76,56,"id"],[70,75,76,4],[71,0,77,4],[71,15,77,11],[71,20,77,16,"_pending"],[71,28,77,11],[71,29,77,25,"id"],[71,31,77,11],[71,32,77,4],[72,0,78,3],[75,46,95,26,"event"],[75,51],[75,53,95,33],[76,0,97,4],[76,16,97,12,"event"],[76,21,97,17],[76,22,97,18,"type"],[76,26,97,4],[77,0,98,6],[77,15,98,11],[77,23,98,6],[78,0,99,8],[78,17,99,13,"_handleUpdate"],[78,30,99,8],[78,31,99,27,"event"],[78,36,99,8],[80,0,101,8],[82,0,103,6],[82,15,103,11],[82,22,103,6],[83,0,104,8],[83,17,104,13,"_handleError"],[83,29,104,8],[83,30,104,26,"event"],[83,35,104,8],[85,0,106,8],[87,0,108,6],[87,15,108,11],[87,25,108,6],[88,0,109,8],[88,17,109,13,"_handleComplete"],[88,32,109,8],[88,33,109,29,"event"],[88,38,109,8],[90,0,111,8],[91,0,97,4],[92,0,113,3],[95,36,122,22,"event"],[95,41],[102,0,124,6,"id"],[102,16,124,6,"id"],[102,18],[102,21,125,8,"event"],[102,26],[102,27,124,6,"id"],[102,29],[104,20,127,9],[104,25,127,14,"_pending"],[104,33,127,9],[104,34,127,23,"id"],[104,36,127,9],[104,37],[109,49,127,35],[109,54,127,40,"_remove"],[109,61,127,35],[109,62,127,48,"id"],[109,64,127,35],[109,65],[112,36,131,8],[112,41,131,13,"_pending"],[112,49,131,8],[112,50,131,22,"id"],[112,52,131,8],[112,53],[112,55,129,6,"meta"],[112,59],[112,80,129,6,"meta"],[112,84],[112,86,130,6,"transaction"],[112,97],[112,118,130,6,"transaction"],[112,129],[113,0,133,6,"updateFunction"],[113,16,133,6,"updateFunction"],[113,30],[113,33,135,8,"meta"],[113,37],[113,38,133,6,"updateFunction"],[113,52],[113,54,134,6,"reject"],[113,60],[113,63,135,8,"meta"],[113,67],[113,68,134,6,"reject"],[113,74],[115,0,137,4,"transaction"],[115,16,137,4,"transaction"],[115,27,137,15],[115,28,137,16,"_prepare"],[115,36,137,4],[118,0,144,12,"possiblePromise"],[118,16,144,12,"possiblePromise"],[118,31],[118,34,144,30,"updateFunction"],[118,48,144,44],[118,49,144,45,"transaction"],[118,60,144,44],[118,61],[120,22,147,10],[120,23,147,11,"possiblePromise"],[120,38,147,10],[120,42,147,30],[120,43,147,31,"possiblePromise"],[120,58,147,46],[120,59,147,47,"then"],[120,63],[125,0,148,8,"finalError"],[125,16,148,8,"finalError"],[125,26,148,18],[125,29,148,21],[125,33,148,25,"Error"],[125,38,148,21],[125,39,148,31],[125,126,148,21],[125,127,148,8],[131,50,150,30,"possiblePromise"],[131,65],[134,0,150,8,"pendingResult"],[134,16,150,8,"pendingResult"],[134,29],[143,0,155,6,"updateFailed"],[143,16,155,6,"updateFailed"],[143,28,155,18],[143,31,155,21],[143,35,155,6],[144,0,156,6,"finalError"],[144,16,156,6,"finalError"],[144,26,156,16],[144,40,156,6],[147,22,162,8,"updateFailed"],[147,34,162,20],[147,38,162,24,"finalError"],[147,48],[152,49,164,13,"reject"],[152,55,164,19],[152,56,164,20,"finalError"],[152,66,164,19],[152,67],[155,0,170,4,"transaction"],[155,16,170,4,"transaction"],[155,27,170,15],[155,28,170,16,"_pendingResult"],[155,42,170,4],[155,45,170,33,"pendingResult"],[155,58,170,4],[156,49,172,11],[156,78,172,27],[156,83,172,32,"_firestore"],[156,93,172,11],[156,95,172,44,"transactionApplyBuffer"],[156,117,172,11],[156,118,172,67,"id"],[156,120,172,11],[156,122,172,71,"transaction"],[156,133,172,82],[156,134,172,83,"_commandBuffer"],[156,148,172,11],[156,149],[167,35,182,15,"event"],[167,40],[167,42,182,22],[168,0,182,22],[168,12,184,6,"id"],[168,14,182,22],[168,17,186,8,"event"],[168,22,182,22],[168,23,184,6,"id"],[168,25,182,22],[169,0,182,22],[169,12,185,6,"error"],[169,17,182,22],[169,20,186,8,"event"],[169,25,182,22],[169,26,185,6,"error"],[169,31,182,22],[170,0,182,22],[170,12,188,6,"meta"],[170,16,182,22],[170,19,189,8],[170,24,189,13,"_pending"],[170,32,189,8],[170,33,189,22,"id"],[170,35,189,8],[170,36,182,22],[170,37,188,6,"meta"],[170,41,182,22],[172,0,191,4],[172,12,191,8,"meta"],[172,16,191,12],[172,20,191,16,"error"],[172,25,191,4],[172,27,191,23],[173,0,191,23],[173,14,193,8,"code"],[173,18,191,23],[173,21,195,10,"error"],[173,26,191,23],[173,27,193,8,"code"],[173,31,191,23],[174,0,191,23],[174,14,194,8,"message"],[174,21,191,23],[174,24,195,10,"error"],[174,29,191,23],[174,30,194,8,"message"],[174,37,191,23],[175,0,199,6],[175,14,199,12,"errorWithStack"],[175,28,199,26],[175,31,199,29],[175,35,199,33,"Error"],[175,40,199,29],[175,41,199,39,"message"],[175,48,199,29],[175,49,199,6],[176,0,201,6,"errorWithStack"],[176,10,201,6,"errorWithStack"],[176,24,201,20],[176,25,201,21,"code"],[176,29,201,6],[176,32,201,28,"code"],[176,36,201,6],[177,0,203,6,"errorWithStack"],[177,10,203,6,"errorWithStack"],[177,24,203,20],[177,25,203,21,"stack"],[177,30,203,6],[177,45,203,39,"message"],[177,52,203,6],[177,62,203,51,"meta"],[177,66,203,55],[177,67,203,56,"stack"],[177,72,203,6],[178,0,205,6,"meta"],[178,10,205,6,"meta"],[178,14,205,10],[178,15,205,11,"reject"],[178,21,205,6],[178,22,205,18,"errorWithStack"],[178,36,205,6],[179,0,206,5],[180,0,207,3],[183,38,216,18,"event"],[183,43],[183,45,216,25],[184,0,216,25],[184,12,218,6,"id"],[184,14,216,25],[184,17,219,8,"event"],[184,22,216,25],[184,23,218,6,"id"],[184,25,216,25],[185,0,216,25],[185,33,223,8],[185,38,223,13,"_pending"],[185,46,223,8],[185,47,223,22,"id"],[185,49,223,8],[185,50,216,25],[186,0,216,25],[186,12,221,6,"meta"],[186,16,216,25],[186,38,221,6,"meta"],[186,42,216,25],[187,0,216,25],[187,12,222,6,"transaction"],[187,23,216,25],[187,45,222,6,"transaction"],[187,56,216,25],[189,0,225,4],[189,12,225,8,"meta"],[189,16,225,4],[189,18,225,14],[190,0,226,6],[190,14,226,12,"pendingResult"],[190,27,226,25],[190,30,226,28,"transaction"],[190,41,226,39],[190,42,226,40,"_pendingResult"],[190,56,226,6],[191,0,228,6,"meta"],[191,10,228,6,"meta"],[191,14,228,10],[191,15,228,11,"resolve"],[191,22,228,6],[191,23,228,19,"pendingResult"],[191,36,228,6],[192,0,229,5],[193,0,230,3]]},"type":"js/module"}]}