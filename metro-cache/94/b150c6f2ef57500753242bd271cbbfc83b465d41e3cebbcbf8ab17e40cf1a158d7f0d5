{"dependencies":[{"name":"@babel/runtime/helpers/interopRequireDefault","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/extends","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/classCallCheck","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/createClass","data":{"isAsync":false}},{"name":"../../utils/events","data":{"isAsync":false}},{"name":"../../utils/log","data":{"isAsync":false}},{"name":"../../utils/native","data":{"isAsync":false}}],"output":[{"data":{"code":"__d(function (global, _$$_REQUIRE, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  var _interopRequireDefault = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\");\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = void 0;\n\n  var _extends2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[1], \"@babel/runtime/helpers/extends\"));\n\n  var _classCallCheck2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[2], \"@babel/runtime/helpers/classCallCheck\"));\n\n  var _createClass2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[3], \"@babel/runtime/helpers/createClass\"));\n\n  var _events = _$$_REQUIRE(_dependencyMap[4], \"../../utils/events\");\n\n  var _log = _$$_REQUIRE(_dependencyMap[5], \"../../utils/log\");\n\n  var _native = _$$_REQUIRE(_dependencyMap[6], \"../../utils/native\");\n\n  var transactionId = 0;\n\n  var generateTransactionId = function generateTransactionId() {\n    return transactionId++;\n  };\n\n  var TransactionHandler = function () {\n    function TransactionHandler(database) {\n      (0, _classCallCheck2.default)(this, TransactionHandler);\n      this._transactions = {};\n      this._database = database;\n\n      _events.SharedEventEmitter.addListener((0, _events.getAppEventName)(this._database, 'database_transaction_event'), this._handleTransactionEvent.bind(this));\n    }\n\n    (0, _createClass2.default)(TransactionHandler, [{\n      key: \"add\",\n      value: function add(reference, transactionUpdater, onComplete) {\n        var applyLocally = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n        var id = generateTransactionId();\n        this._transactions[id] = {\n          id: id,\n          reference: reference,\n          transactionUpdater: transactionUpdater,\n          onComplete: onComplete,\n          applyLocally: applyLocally,\n          completed: false,\n          started: true\n        };\n        (0, _native.getNativeModule)(this._database).transactionStart(reference.path, id, applyLocally);\n      }\n    }, {\n      key: \"_handleTransactionEvent\",\n      value: function _handleTransactionEvent() {\n        var event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n        switch (event.type) {\n          case 'update':\n            return this._handleUpdate(event);\n\n          case 'error':\n            return this._handleError(event);\n\n          case 'complete':\n            return this._handleComplete(event);\n\n          default:\n            (0, _log.getLogger)(this._database).warn(\"Unknown transaction event type: '\" + event.type + \"'\", event);\n            return undefined;\n        }\n      }\n    }, {\n      key: \"_handleUpdate\",\n      value: function _handleUpdate() {\n        var event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        var newValue;\n        var id = event.id,\n            value = event.value;\n\n        try {\n          var transaction = this._transactions[id];\n          if (!transaction) return;\n          newValue = transaction.transactionUpdater(value);\n        } finally {\n          var abort = false;\n\n          if (newValue === undefined) {\n            abort = true;\n          }\n\n          (0, _native.getNativeModule)(this._database).transactionTryCommit(id, {\n            value: newValue,\n            abort: abort\n          });\n        }\n      }\n    }, {\n      key: \"_handleError\",\n      value: function _handleError() {\n        var _this = this;\n\n        var event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        var transaction = this._transactions[event.id];\n\n        if (transaction && !transaction.completed) {\n          transaction.completed = true;\n\n          try {\n            transaction.onComplete(event.error, false, null);\n          } finally {\n            setImmediate(function () {\n              delete _this._transactions[event.id];\n            });\n          }\n        }\n      }\n    }, {\n      key: \"_handleComplete\",\n      value: function _handleComplete() {\n        var _this2 = this;\n\n        var event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        var transaction = this._transactions[event.id];\n\n        if (transaction && !transaction.completed) {\n          transaction.completed = true;\n\n          try {\n            transaction.onComplete(null, event.committed, (0, _extends2.default)({}, event.snapshot));\n          } finally {\n            setImmediate(function () {\n              delete _this2._transactions[event.id];\n            });\n          }\n        }\n      }\n    }]);\n    return TransactionHandler;\n  }();\n\n  exports.default = TransactionHandler;\n});","map":[[15,0,5,0],[17,0,6,0],[19,0,7,0],[21,0,8,0],[21,6,8,4,"transactionId"],[21,19,8,17],[21,22,8,20],[21,23,8,0],[23,0,15,0],[23,6,15,6,"generateTransactionId"],[23,27,15,27],[23,30,15,30],[23,39,15,6,"generateTransactionId"],[23,60,15,30],[24,0,15,30],[24,11,15,36,"transactionId"],[24,24,15,49],[24,26,15,30],[25,0,15,30],[25,3,15,0],[27,6,21,21,"TransactionHandler"],[27,24],[28,0,22,2],[28,32,22,14,"database"],[28,40,22,2],[28,42,22,24],[29,0,22,24],[30,0,23,4],[30,11,23,9,"_transactions"],[30,24,23,4],[30,27,23,25],[30,29,23,4],[31,0,24,4],[31,11,24,9,"_database"],[31,20,24,4],[31,23,24,21,"database"],[31,31,24,4],[33,0,25,4,"SharedEventEmitter"],[33,33,25,23,"addListener"],[33,44,25,4],[33,45,25,35],[33,74,25,51],[33,79,25,56,"_database"],[33,88,25,35],[33,90,25,67],[33,118,25,35],[33,119,25,4],[33,121,25,98],[33,126,25,103,"_handleTransactionEvent"],[33,149,25,98],[33,150,25,127,"bind"],[33,154,25,98],[33,155,25,132],[33,159,25,98],[33,160,25,4],[34,0,26,3],[38,26,36,6,"reference"],[38,35],[38,37,36,17,"transactionUpdater"],[38,55],[38,57,36,37,"onComplete"],[38,67],[38,69,36,71],[39,0,36,71],[39,12,36,49,"applyLocally"],[39,24,36,71],[39,95,36,64],[39,100,36,71],[40,0,37,4],[40,12,37,10,"id"],[40,14,37,12],[40,17,37,15,"generateTransactionId"],[40,38,37,36],[40,40,37,4],[41,0,38,4],[41,13,38,9,"_transactions"],[41,26,38,4],[41,27,38,23,"id"],[41,29,38,4],[41,33,38,29],[42,0,39,6,"id"],[42,10,39,6,"id"],[42,12,39,8],[42,14,39,6,"id"],[42,16,38,29],[43,0,40,6,"reference"],[43,10,40,6,"reference"],[43,19,40,15],[43,21,40,6,"reference"],[43,30,38,29],[44,0,41,6,"transactionUpdater"],[44,10,41,6,"transactionUpdater"],[44,28,41,24],[44,30,41,6,"transactionUpdater"],[44,48,38,29],[45,0,42,6,"onComplete"],[45,10,42,6,"onComplete"],[45,20,42,16],[45,22,42,6,"onComplete"],[45,32,38,29],[46,0,43,6,"applyLocally"],[46,10,43,6,"applyLocally"],[46,22,43,18],[46,24,43,6,"applyLocally"],[46,36,38,29],[47,0,44,6,"completed"],[47,10,44,6,"completed"],[47,19,44,15],[47,21,44,17],[47,26,38,29],[48,0,45,6,"started"],[48,10,45,6,"started"],[48,17,45,13],[48,19,45,15],[49,0,38,29],[49,9,38,4],[50,0,47,4],[50,37,47,20],[50,42,47,25,"_database"],[50,51,47,4],[50,53,47,36,"transactionStart"],[50,69,47,4],[50,70,47,53,"reference"],[50,79,47,62],[50,80,47,63,"path"],[50,84,47,4],[50,86,47,69,"id"],[50,88,47,4],[50,90,47,73,"applyLocally"],[50,102,47,4],[51,0,48,3],[54,48,61,38],[55,0,61,38],[55,12,61,26,"event"],[55,17,61,38],[55,88,61,34],[55,90,61,38],[57,0,62,4],[57,16,62,12,"event"],[57,21,62,17],[57,22,62,18,"type"],[57,26,62,4],[58,0,63,6],[58,15,63,11],[58,23,63,6],[59,0,64,8],[59,19,64,15],[59,24,64,20,"_handleUpdate"],[59,37,64,15],[59,38,64,34,"event"],[59,43,64,15],[59,44,64,8],[61,0,66,6],[61,15,66,11],[61,22,66,6],[62,0,67,8],[62,19,67,15],[62,24,67,20,"_handleError"],[62,36,67,15],[62,37,67,33,"event"],[62,42,67,15],[62,43,67,8],[64,0,69,6],[64,15,69,11],[64,25,69,6],[65,0,70,8],[65,19,70,15],[65,24,70,20,"_handleComplete"],[65,39,70,15],[65,40,70,36,"event"],[65,45,70,15],[65,46,70,8],[67,0,72,6],[68,0,73,8],[68,32,73,18],[68,37,73,23,"_database"],[68,46,73,8],[68,48,73,34,"warn"],[68,52,73,8],[68,91,73,75,"event"],[68,96,73,80],[68,97,73,81,"type"],[68,101,73,8],[68,109,73,90,"event"],[68,114,73,8],[69,0,74,8],[69,19,74,15,"undefined"],[69,28,74,8],[70,0,62,4],[71,0,76,3],[74,38,84,28],[75,0,84,28],[75,12,84,16,"event"],[75,17,84,28],[75,88,84,24],[75,90,84,28],[76,0,85,4],[76,12,85,8,"newValue"],[76,20,85,4],[77,0,84,28],[77,12,87,6,"id"],[77,14,84,28],[77,17,89,8,"event"],[77,22,84,28],[77,23,87,6,"id"],[77,25,84,28],[78,0,84,28],[78,12,88,6,"value"],[78,17,84,28],[78,20,89,8,"event"],[78,25,84,28],[78,26,88,6,"value"],[78,31,84,28],[80,0,91,4],[80,12,91,8],[81,0,92,6],[81,14,92,12,"transaction"],[81,25,92,23],[81,28,92,26],[81,33,92,31,"_transactions"],[81,46,92,26],[81,47,92,45,"id"],[81,49,92,26],[81,50,92,6],[82,0,93,6],[82,14,93,10],[82,15,93,11,"transaction"],[82,26,93,6],[82,28,93,24],[83,0,94,6,"newValue"],[83,10,94,6,"newValue"],[83,18,94,14],[83,21,94,17,"transaction"],[83,32,94,28],[83,33,94,29,"transactionUpdater"],[83,51,94,17],[83,52,94,48,"value"],[83,57,94,17],[83,58,94,6],[84,0,95,5],[84,9,91,4],[84,18,95,14],[85,0,96,6],[85,14,96,10,"abort"],[85,19,96,15],[85,22,96,18],[85,27,96,6],[87,0,98,6],[87,14,98,10,"newValue"],[87,22,98,18],[87,27,98,23,"undefined"],[87,36,98,6],[87,38,98,34],[88,0,99,8,"abort"],[88,12,99,8,"abort"],[88,17,99,13],[88,20,99,16],[88,24,99,8],[89,0,100,7],[91,0,102,6],[91,39,102,22],[91,44,102,27,"_database"],[91,53,102,6],[91,55,102,38,"transactionTryCommit"],[91,75,102,6],[91,76,102,59,"id"],[91,78,102,6],[91,80,102,63],[92,0,103,8,"value"],[92,12,103,8,"value"],[92,17,103,13],[92,19,103,15,"newValue"],[92,27,102,63],[93,0,104,8,"abort"],[93,12,104,8,"abort"],[93,17,104,13],[93,19,104,8,"abort"],[94,0,102,63],[94,11,102,6],[95,0,106,5],[96,0,107,3],[99,37,115,27],[100,0,115,27],[102,0,115,27],[102,12,115,15,"event"],[102,17,115,27],[102,88,115,23],[102,90,115,27],[103,0,116,4],[103,12,116,10,"transaction"],[103,23,116,21],[103,26,116,24],[103,31,116,29,"_transactions"],[103,44,116,24],[103,45,116,43,"event"],[103,50,116,48],[103,51,116,49,"id"],[103,53,116,24],[103,54,116,4],[105,0,118,4],[105,12,118,8,"transaction"],[105,23,118,19],[105,27,118,23],[105,28,118,24,"transaction"],[105,39,118,35],[105,40,118,36,"completed"],[105,49,118,4],[105,51,118,47],[106,0,119,6,"transaction"],[106,10,119,6,"transaction"],[106,21,119,17],[106,22,119,18,"completed"],[106,31,119,6],[106,34,119,30],[106,38,119,6],[108,0,121,6],[108,14,121,10],[109,0,122,8,"transaction"],[109,12,122,8,"transaction"],[109,23,122,19],[109,24,122,20,"onComplete"],[109,34,122,8],[109,35,122,31,"event"],[109,40,122,36],[109,41,122,37,"error"],[109,46,122,8],[109,48,122,44],[109,53,122,8],[109,55,122,51],[109,59,122,8],[110,0,123,7],[110,11,121,6],[110,20,123,16],[111,0,124,8,"setImmediate"],[111,12,124,8,"setImmediate"],[111,24,124,20],[111,25,124,21],[111,37,124,27],[112,0,125,10],[112,21,125,17],[112,26,125,21],[112,27,125,22,"_transactions"],[112,40,125,17],[112,41,125,36,"event"],[112,46,125,41],[112,47,125,42,"id"],[112,49,125,17],[112,50,125,10],[113,0,126,9],[113,13,124,20],[113,14,124,8],[114,0,127,7],[115,0,128,5],[116,0,129,3],[119,40,137,30],[120,0,137,30],[122,0,137,30],[122,12,137,18,"event"],[122,17,137,30],[122,88,137,26],[122,90,137,30],[123,0,138,4],[123,12,138,10,"transaction"],[123,23,138,21],[123,26,138,24],[123,31,138,29,"_transactions"],[123,44,138,24],[123,45,138,43,"event"],[123,50,138,48],[123,51,138,49,"id"],[123,53,138,24],[123,54,138,4],[125,0,140,4],[125,12,140,8,"transaction"],[125,23,140,19],[125,27,140,23],[125,28,140,24,"transaction"],[125,39,140,35],[125,40,140,36,"completed"],[125,49,140,4],[125,51,140,47],[126,0,141,6,"transaction"],[126,10,141,6,"transaction"],[126,21,141,17],[126,22,141,18,"completed"],[126,31,141,6],[126,34,141,30],[126,38,141,6],[128,0,143,6],[128,14,143,10],[129,0,144,8,"transaction"],[129,12,144,8,"transaction"],[129,23,144,19],[129,24,144,20,"onComplete"],[129,34,144,8],[129,35,144,31],[129,39,144,8],[129,41,144,37,"event"],[129,46,144,42],[129,47,144,43,"committed"],[129,56,144,8],[129,58,144,54],[129,81,144,68],[129,83,144,54],[129,85,144,72,"event"],[129,90,144,77],[129,91,144,78,"snapshot"],[129,99,144,54],[129,100,144,8],[130,0,145,7],[130,11,143,6],[130,20,145,16],[131,0,146,8,"setImmediate"],[131,12,146,8,"setImmediate"],[131,24,146,20],[131,25,146,21],[131,37,146,27],[132,0,147,10],[132,21,147,17],[132,27,147,21],[132,28,147,22,"_transactions"],[132,41,147,17],[132,42,147,36,"event"],[132,47,147,41],[132,48,147,42,"id"],[132,50,147,17],[132,51,147,10],[133,0,148,9],[133,13,146,20],[133,14,146,8],[134,0,149,7],[135,0,150,5],[136,0,151,3]]},"type":"js/module"}]}